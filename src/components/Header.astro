---
import 'flag-icons/css/flag-icons.min.css';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { useTranslations } from '@i18n/utils';
import type { Lang } from '@i18n/ui';
import MainNav from './MainNav.astro';

const locale = Astro.currentLocale as Lang;

const t = useTranslations(locale);

const currentPathWithoutLocale = Astro.url.pathname.replace(
  new RegExp(`^/(?:${locale})(/|$)`, 'i'),
  '/',
);

const homeUrl = getRelativeLocaleUrl(locale, '');

const localeMap = {
  en: {
    localeName: 'En',
    localeFlagClass: 'gb',
    localeLangKey: 'locale.english',
  },
  cy: {
    localeName: 'Cy',
    localeFlagClass: 'gb-wls',
    localeLangKey: 'locale.welsh',
  },
};

const { localeName, localeFlagClass, localeLangKey } = localeMap[locale];
---

<header class="site-header">
  <a
    href={homeUrl}
    class="dm-sans-500-normal logo-link"
  >
    <span>UV</span>
  </a>
  <button
    type="button"
    id="mobileNavButton"
    class="hamburger mobile-main-nav-button"
  >
    <span class="hamburger-box">
      <span class="hamburger-inner"></span>
    </span>
  </button>
  <MainNav />
  <div class="languages-container">
    <button
      type="button"
      id="showLanguagesButton"
      class="show-languages-button"
      aria-label="Select language"
      aria-expanded="false"
    >
      <span
        class={`fi fi-${localeFlagClass} language-flag current-language-flag`}
      ></span>
      <!-- {localeName} --></button
    >
    <nav
      id="langNav"
      class="lang-nav"
    >
      <ul class="lang-nav-list">
        <li class="lang-nav-list-item">
          <a
            href={currentPathWithoutLocale}
            class="lang-nav-link"
          >
            <span class="fi fi-gb language-flag"></span>
            <span class="language-name">English</span>
          </a>
        </li>
        <li class="lang-nav-list-item">
          <a
            href={`/cy${currentPathWithoutLocale}`}
            class="lang-nav-link"
          >
            <span class="fi fi-gb-wls language-flag"></span>
            <span class="language-name">Welsh</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</header>
<script>
  const langButton = document.getElementById('showLanguagesButton');
  const langNav = document.getElementById('langNav');
  langButton?.addEventListener('click', () => {
    langNav?.classList.toggle('show');
  });

  document.addEventListener('click', (e: Event) => {
    const target = e.target;

    if (!(target instanceof HTMLElement)) return;

    if (target != langButton && target.parentElement != langButton) {
      langNav?.classList.remove('show');
    }
  });

  const mobileNavButton = document.getElementById('mobileNavButton');
  const mainNav = document.getElementById('mainNav');
  mobileNavButton?.addEventListener('click', function () {
    this.classList.toggle('active');

    if (this.classList.contains('active')) {
      mainNav?.classList.add('show');
    } else {
      mainNav?.classList.remove('show');
    }
  });
</script>
